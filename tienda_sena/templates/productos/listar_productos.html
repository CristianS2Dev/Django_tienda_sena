{% extends 'bases/base.html' %}
{% load static humanize custom_filters cloudinary_tags %}

{% block titulo %}Tienda Sena{% endblock %}

{% block main %}
<div class="container-fluid py-5">
    <div id="notificaciones">
  {% if messages %}
      {% for message in messages %} 
<div class="alert alert-{% if message.tags and message.tags != 'error' %}{{ message.tags}}{% else %}danger{% endif %} alert-dismissible fade show" role="alert"> {{ message}} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}
    
    <div class="row">
        <!-- Sidebar de filtros -->
        <div class="col-md-3">
            <form method="get" class="bg-white p-4 shadow-sm rounded-3 mb-4">
                <!-- Filtros de categor칤a, precio, marca y colores -->
                <h5 class="fw-bold mb-4">Filtros</h5>
                <!-- Categor칤a -->
                <div class="mb-4">
                    <h6 class="text-muted">
                        <i class="fas fa-filter"></i> Categor칤as
                    </h6>
                    <select name="categoria" class="form-select" onchange="this.form.submit()">
                        <option value="">游늬 Todas las categor칤as</option>
                        {% for key, value in categorias %}
                            <option value="{{ key }}" 
                                    {% if key|stringformat:"s" == request.GET.categoria %}selected{% endif %}>
                                {{ value }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Precio -->
                <div class="mb-4">
                    <h6 class="text-muted">Precio</h6>
                    <input type="number" name="precio_min" class="form-control mb-2" placeholder="M칤nimo" value="{{ request.GET.precio_min }}">
                    <input type="number" name="precio_max" class="form-control" placeholder="M치ximo" value="{{ request.GET.precio_max }}">
                </div>
                <!-- Colores -->
                <div class="mb-4">
                    <h6 class="text-muted">Colores</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% for color in colores_con_codigo %}
                            <label style="cursor: pointer;">
                            <input type="checkbox" name="color" value="{{ color.id }}" class="d-none" {% if color.id|stringformat:"s" in request.GET.color %}checked{% endif %}>
                                <div class="rounded-circle border border-light color-circle" data-color="{{ color.codigo }}" style="width: 20px; height: 20px;"></div>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <button type="submit" class="btn btn-dark w-100 mt-3">Aplicar Filtros</button>
                <a href="{% url 'lista_productos' %}" class="btn btn-outline-secondary w-100 mt-2">Limpiar Filtros</a>
            </form>
        </div>

        <!-- Grid de productos -->
        <div class="col-md-9">
            {% if usuario_logueado %}
                {% if request.session.pista.rol == 2 %}
                    <a class="btn btn-warning" href="{% url 'actualizar_perfil' %}">Quiero Vender</a>
                {% elif mostrar_boton_agregar %}    
                    <a class="btn btn-success" href="{% url 'agregar_producto' %}">Agregar productos</a>
                    {% if user_session.is_authenticated and user_session.id %}
                        <a class="btn btn-warning" href="{% url 'productos_vendedor' user_session.id %}">Mis productos</a>
                    {% endif %}
                {% endif %}
            {% endif %}
            
            <!-- Filtros de ordenamiento b치sicos -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold">
                    {% if request.GET.nombre %}
                        Resultados para "{{ request.GET.nombre }}"
                    {% elif categoria %}
                        {{ categoria }}
                    {% else %}
                        Todos los productos
                    {% endif %}
                </h4>
                <div class="mb-2 w-auto">
                    <select name="orden" class="form-select" onchange="this.form.submit()">
                        <option value="popular" {% if request.GET.orden == 'popular' or not request.GET.orden %}selected{% endif %}>M치s populares</option>
                        <option value="barato" {% if request.GET.orden == 'barato' %}selected{% endif %}>M치s baratos</option>
                        <option value="caro" {% if request.GET.orden == 'caro' %}selected{% endif %}>M치s caros</option>
                    </select>
                </div>
            </div>
            <div class="row g-4">
                {% if data %}
                    {% include 'bases/_productos.html' %}
                {% else %}
                    <div class="alert alert-info text-center w-100">
                        No hay productos disponibles que coincidan con los filtros aplicados.
                    </div>
                {% endif %}
                
            </div>
            <!-- Paginaci칩n -->
            <div class="d-flex justify-content-center mt-4">
                <nav>
                    <ul class="pagination pagination-sm">
                        {% if data.has_previous %}
                            <li class="page-item"><a class="page-link" href="?page={{ data.previous_page_number }}">춺</a></li>
                        {% endif %}
                        {% for num in data.paginator.page_range %}
                            <li class="page-item {% if data.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                        {% endfor %}
                        {% if data.has_next %}
                            <li class="page-item"><a class="page-link" href="?page={{ data.next_page_number }}">췉</a></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar colores din치micamente a los c칤rculos de color
    document.querySelectorAll('.color-circle').forEach(function(circle) {
        const colorCode = circle.getAttribute('data-color');
        if (colorCode) {
            circle.style.backgroundColor = colorCode;
        } else {
            circle.style.backgroundColor = '#cccccc'; // Color por defecto
        }
    });
});
</script>

{% endblock %}

